;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;; Defines a virtual reality actor which can be entered into a trial scene.

(in-package #:org.shirakumo.fraf.trial.vr)

(defclass actor ()
  ((name :initarg :actor)))
 
(defmethod trial:enter ((unit actor) scene)
  (let* ((head (make-instance 'head))
         (left-render-pass (make-instance 'left-eye-render-pass))
         (right-render-pass (make-instance 'right-eye-render-pass))
         (compositor-render-pass (make-instance 'compositor-render-pass))
         (ui-1 (make-instance 'dui :target-resolution (alloy:px-size 800 600)))
         (ui-render-pass-1 (make-instance 'ui-render-pass :overlay-key "First overlay" :dui ui-1))
         (ui-2 (make-instance 'dui :target-resolution (alloy:px-size 800 600)))
         (ui-render-pass-2 (make-instance 'ui-render-pass :overlay-key "Second overlay" :dui ui-2))
         (ui-compositor-render-pass (make-instance 'ui-compositor-render-pass))
         (focus-1 (make-instance 'alloy:focus-list :focus-parent (alloy:focus-tree ui-1)))
         (layout-1 (make-instance 'alloy:vertical-linear-layout
                                 :layout-parent (org.shirakumo.alloy:layout-tree ui-1)))
         (focus-2 (make-instance 'alloy:focus-list :focus-parent (alloy:focus-tree ui-2)))
         (layout-2 (make-instance 'alloy:vertical-linear-layout
                                 :layout-parent (org.shirakumo.alloy:layout-tree ui-2))))
    (let* ((data (3d-vectors:vec2 0 1))
           (vec (org.shirakumo.alloy:represent data 'trial-alloy::vec2
                                               :focus-parent focus-1 :layout-parent layout-1)))
      (alloy:on (setf alloy:value) (value vec)
        (print value)))
    (let* ((data (3d-vectors:vec2 2 3))
           (vec (org.shirakumo.alloy:represent data 'trial-alloy::vec2
                                               :focus-parent focus-2 :layout-parent layout-2)))
      (alloy:on (setf alloy:value) (value vec)
        (print value)))
    (trial:enter head scene)
    (trial:enter left-render-pass scene)
    (trial:enter right-render-pass scene)
    (trial:enter compositor-render-pass scene)
    (trial:enter ui-render-pass-1 scene)
    (trial:enter ui-render-pass-2 scene)
    (trial:enter ui-compositor-render-pass scene)
    (trial:enter ui-1 scene)
    (trial:enter ui-2 scene)
    (trial:connect (trial:port left-render-pass 'trial:color)
                   (trial:port compositor-render-pass 'left-pass-color)
                   scene)
    (trial:connect (trial:port right-render-pass 'trial:color)
                   (trial:port compositor-render-pass 'right-pass-color)
                   scene)
    (trial:connect (trial:port left-render-pass 'trial:depth)
                   (trial:port compositor-render-pass 'left-pass-depth)
                   scene)
    (trial:connect (trial:port right-render-pass 'trial:depth)
                   (trial:port compositor-render-pass 'right-pass-depth)
                   scene)
    (trial:connect (trial:port ui-render-pass-1 'trial:color)
                   (trial:port ui-compositor-render-pass 'ui-pass-1)
                   scene)
    (trial:connect (trial:port ui-render-pass-2 'trial:color)
                   (trial:port ui-compositor-render-pass 'ui-pass-2)
                   scene)))
